<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Inventory App</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:12px}
button{padding:6px 10px;border:none;background:#007bff;color:white;border-radius:6px;cursor:pointer}
button.red{background:#dc3545}
.hidden{display:none}
.card{background:white;padding:12px;margin-top:12px;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.08)}
.variant{background:#f7f7f7;padding:6px;margin-top:6px;border-radius:6px}
.color{font-weight:bold}
.sizeRow{display:flex;justify-content:space-between;margin-top:4px}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10000}
.modalInner{background:white;padding:14px;border-radius:10px;width:320px;max-height:90%;overflow:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#eee}
input{width:100%;padding:6px;margin-bottom:6px}
img.prodImg{width:80px;border-radius:6px;margin-bottom:6px}
#loginBox{z-index:9999;position:relative;background:#fff;padding:20px;border-radius:8px;max-width:300px;margin:100px auto;box-shadow:0 4px 8px rgba(0,0,0,.2)}
#appUI{display:flex;flex-direction:column}
#qrScanner{width:100%;max-width:320px;margin-top:10px}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginBox">
  <h3>Login</h3>
  <input id="email" type="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
</div>

<!-- MAIN APP -->
<div id="appUI" class="hidden">

<header>
  <h3>Inventory</h3>
  <div>
    <button id="scanBtn" onclick="startScan()">Scan QR</button>
    <button id="dailyBtn" class="hidden" onclick="openDailySummary()">Daily Summary</button>
    <button id="auditBtn" class="hidden" onclick="openAudit()">Audit Logs</button>
    <button id="addBtn" class="hidden" onclick="showAdd()">Add Product</button>
    <button onclick="logout()" class="red">Logout</button>
  </div>
</header>

<input id="search" placeholder="Search code or name" oninput="filter()">
<div id="list"></div>
<div id="qrScanner" class="hidden"></div>

<!-- ADD PRODUCT MODAL -->
<div id="addBox" class="modal hidden">
  <div class="modalInner">
    <h3>Add Product</h3>
    <input id="pCode" placeholder="Code">
    <input id="pName" placeholder="Name">
    <input id="pColor" placeholder="Color">
    <input id="pSize" placeholder="Size">
    <input id="pStock" type="number" placeholder="Stock">
    <input type="file" id="pImage" accept="image/*" capture="environment">
    <button onclick="addProduct()">Save Product</button>
    <button class="red" onclick="hideAdd()">Cancel</button>
  </div>
</div>

<!-- AUDIT LOG MODAL -->
<div id="auditBox" class="modal hidden">
  <div class="modalInner">
    <h3>Audit Logs</h3>
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Code</th><th>Color</th><th>Size</th><th>Action</th><th>Qty</th><th>By</th>
        </tr>
      </thead>
      <tbody id="auditBody"></tbody>
    </table>
    <button class="red" onclick="closeAudit()">Close</button>
  </div>
</div>

<!-- DAILY SUMMARY MODAL -->
<div id="summaryBox" class="modal hidden">
  <div class="modalInner">
    <h3>Daily Stock Movement</h3>
    <input type="date" id="summaryDate">
    <table>
      <thead>
        <tr>
          <th>Code</th><th>Color</th><th>Size</th><th>IN</th><th>OUT</th><th>NET</th>
        </tr>
      </thead>
      <tbody id="summaryBody"></tbody>
    </table>
    <button onclick="closeSummary()">Close</button>
  </div>
</div>

<script>
// ðŸ”¥ Firebase config
firebase.initializeApp({

  apiKey: "AIzaSyAMOEoWseBnscSrmpnZ2u9U7tgtuwWHeh4",
  authDomain: "inventory-app-9f7a3.firebaseapp.com",
  projectId: "inventory-app-9f7a3"
});
const auth = firebase.auth();
const db = firebase.firestore();

// Cloudinary config
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dahxnopuw/image/upload";
const CLOUDINARY_PRESET = "inventory_unsigned";

let USER_ROLE="staff", ALL_DATA={}, html5QrCode;

// LOGIN
function login(){
  auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message));
}

// AUTH STATE
auth.onAuthStateChanged(async user=>{
  if(!user) return;
  loginBox.classList.add("hidden");
  appUI.classList.remove("hidden");
  const doc = await db.collection("users").doc(user.uid).get();
  USER_ROLE = doc.exists?doc.data().role:"staff";
  if(USER_ROLE==="admin"){
    addBtn.classList.remove("hidden");
    dailyBtn.classList.remove("hidden");
    auditBtn.classList.remove("hidden");
  }
  loadInventory();
});

function logout(){ auth.signOut(); }

// LOAD INVENTORY
async function loadInventory(){
  const snap=await db.collection("inventory").get();
  ALL_DATA={};
  snap.forEach(d=>{
    const p=d.data();
    if(!ALL_DATA[p.code]) ALL_DATA[p.code]={code:p.code,name:p.name,variants:{},image:p.imageUrl||""};
    if(!ALL_DATA[p.code].variants[p.color]) ALL_DATA[p.code].variants[p.color]={};
    ALL_DATA[p.code].variants[p.color][p.size] = (ALL_DATA[p.code].variants[p.color][p.size]||0)+Number(p.stock);
  });
  render(ALL_DATA);
}

// RENDER
function render(data){
  list.innerHTML="";
  Object.values(data).forEach(p=>{
    let vhtml="";
    Object.entries(p.variants).forEach(([color,sizes])=>{
      vhtml+=`<div class="variant"><div class="color">${color}</div>`;
      Object.entries(sizes).forEach(([size,qty])=>{
        vhtml+=`<div class="sizeRow"><span>Size ${size}: <b>${qty}</b></span>`;
        if(USER_ROLE==="admin"){
          vhtml+=`<span><button onclick="stockChange('${p.code}','${color}','${size}',1)">+</button><button onclick="stockChange('${p.code}','${color}','${size}',-1)">-</button></span>`;
        }
        vhtml+="</div>";
      });
      vhtml+="</div>";
    });
    list.innerHTML+=`<div class="card">${p.image?`<img src="${p.image}" class="prodImg">`:""}<b>${p.code}</b><br>${p.name}${vhtml}</div>`;
  });
}

// SEARCH
function filter(){
  const q=search.value.toLowerCase();
  const f={};
  Object.values(ALL_DATA).forEach(p=>{
    if(p.code.toLowerCase().includes(q)||p.name.toLowerCase().includes(q)) f[p.code]=p;
  });
  render(f);
}

// STOCK CHANGE
async function stockChange(code,color,size,delta){
  const q=await db.collection("inventory").where("code","==",code).where("color","==",color).where("size","==",size).limit(1).get();
  if(q.empty) return;
  const doc=q.docs[0];
  const newStock=Math.max(0,(doc.data().stock||0)+delta);
  await doc.ref.update({stock:newStock});
  await db.collection("audit_logs").add({code,color,size,action:delta>0?"IN":"OUT",qty:Math.abs(delta),by:USER_ROLE,time:firebase.firestore.FieldValue.serverTimestamp()});
  loadInventory();
}

// ADD PRODUCT
async function uploadImage(file){if(!file) return ""; const fd=new FormData(); fd.append("file",file); fd.append("upload_preset",CLOUDINARY_PRESET); const r=await fetch(CLOUDINARY_URL,{method:"POST",body:fd}); return (await r.json()).secure_url;}
async function addProduct(){
  if(USER_ROLE!=="admin"){alert("Admin only"); return;}
  const imgUrl=await uploadImage(pImage.files[0]);
  await db.collection("inventory").add({code:pCode.value.trim(),name:pName.value.trim(),color:pColor.value.trim(),size:pSize.value.trim(),stock:Number(pStock.value),imageUrl:imgUrl,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
  alert("Product added"); hideAdd(); loadInventory();
}
function showAdd(){addBox.classList.remove("hidden");}
function hideAdd(){addBox.classList.add("hidden");}

// AUDIT LOG
function openAudit(){auditBox.classList.remove("hidden");loadAudit();}
function closeAudit(){auditBox.classList.add("hidden");}
async function loadAudit(){const tbody=auditBody; const snap=await db.collection("audit_logs").orderBy("time","desc").limit(100).get(); tbody.innerHTML=""; snap.forEach(d=>{const a=d.data(); const t=a.time?a.time.toDate().toLocaleString():""; tbody.innerHTML+=`<tr><td>${t}</td><td>${a.code}</td><td>${a.color}</td><td>${a.size}</td><td>${a.action}</td><td>${a.qty}</td><td>${a.by}</td></tr>`}); if(!tbody.innerHTML) tbody.innerHTML="<tr><td colspan='7'>No logs</td></tr>";}

// DAILY SUMMARY
function openDailySummary(){summaryBox.classList.remove("hidden"); summaryDate.value=new Date().toISOString().split("T")[0]; loadSummary(summaryDate.value);}
function closeSummary(){summaryBox.classList.add("hidden");}
summaryDate.onchange=()=>loadSummary(summaryDate.value);
async function loadSummary(dateStr){const tbody=summaryBody; tbody.innerHTML="<tr><td colspan='6'>Loading...</td></tr>"; const s=new Date(dateStr); s.setHours(0,0,0,0); const e=new Date(dateStr); e.setHours(23,59,59,999); const snap=await db.collection("audit_logs").where("time",">=",s).where("time","<=",e).get(); const map={}; snap.forEach(d=>{const a=d.data(); const k=`${a.code}_${a.color}_${a.size}`; if(!map[k]) map[k]={code:a.code,color:a.color,size:a.size,in:0,out:0}; a.action==="IN"?map[k].in+=a.qty:map[k].out+=a.qty;}); tbody.innerHTML=""; Object.values(map).forEach(r=>{const net=r.in-r.out; tbody.innerHTML+=`<tr><td>${r.code}</td><td>${r.color}</td><td>${r.size}</td><td style="color:green">${r.in}</td><td style="color:red">${r.out}</td><td><b>${net>0?"+":""}${net}</b></td></tr>`}); if(!tbody.innerHTML) tbody.innerHTML="<tr><td colspan='6'>No activity</td></tr>";}

// QR SCAN
function startScan(){
  qrScanner.classList.remove("hidden");
  html5QrCode=new Html5Qrcode("qrScanner");
  html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250}, qrCodeMessage=>{
    navigator.vibrate?.(200); new Audio('https://www.soundjay.com/buttons/sounds/beep-07.mp3').play();
    filterQR(qrCodeMessage); stopScan();
  }, errorMessage=>{});
}
function stopScan(){if(html5QrCode) html5QrCode.stop(); qrScanner.classList.add("hidden");}
function filterQR(msg){const q=msg.toLowerCase(); const f={}; Object.values(ALL_DATA).forEach(p=>{if(p.code.toLowerCase()===q) f[p.code]=p}); render(f);}
</script>
</body>
</html>
