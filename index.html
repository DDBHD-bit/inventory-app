<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Inventory App</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- QR -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#f1f5f9;
}

header{
  background:#1e40af;
  color:#fff;
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.container{
  max-width:900px;
  margin:auto;
  padding:16px;
}

.card{
  background:#fff;
  border-radius:12px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}

input, button{
  width:100%;
  padding:10px;
  margin-top:8px;
  border-radius:8px;
  border:1px solid #ccc;
}

button{
  background:#2563eb;
  color:#fff;
  border:none;
}

button.secondary{
  background:#64748b;
}

.product{
  display:flex;
  gap:12px;
}

.product img{
  width:80px;
  height:80px;
  border-radius:10px;
  object-fit:cover;
}

.actions button{
  width:auto;
  margin-right:6px;
}

.low{
  color:red;
  font-weight:bold;
}

/* ðŸ”‘ VISIBILITY CONTROL */
.hidden{
  display:none !important;
}

/* ðŸ”‘ MODAL (FIXED) */
.modal{
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.45);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.modal .card{
  width:100%;
  max-width:420px;
}
</style>
</head>

<body>

<header>
  <b>Inventory</b>
  <button onclick="logout()">Logout</button>
</header>

<!-- LOGIN -->
<div class="container" id="loginBox">
  <div class="card">
    <h3>Login</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>
</div>

<!-- APP -->
<div class="container hidden" id="appBox">
  <input id="search" placeholder="Search..." oninput="loadProducts()">
  <button onclick="showAdd()">âž• Add Product</button>
  <div id="products"></div>
</div>

<!-- ADD PRODUCT MODAL (HIDDEN BY DEFAULT) -->
<div class="modal hidden" id="addBox">
  <div class="card">
    <h3>Add Product</h3>

    <input id="pname" placeholder="Name">
    <input id="pcode" placeholder="Code">
    <input id="pcolor" placeholder="Color">
    <input id="psize" placeholder="Size">
    <input id="pprice" type="number" placeholder="Price">
    <input id="pstock" type="number" placeholder="Stock">
    <input type="file" id="pimage" accept="image/*" capture="environment">

    <button onclick="addProduct()">Save</button>
    <button class="secondary" onclick="hideAdd()">Cancel</button>
  </div>
</div>

<script>
// ðŸ” Firebase
firebase.initializeApp({
  apiKey: "AIzaSyAMOEoWseBnscSrmpnZ2u9U7tgtuwWHeh4",
  authDomain: "inventory-app-9f7a3.firebaseapp.com",
  projectId: "inventory-app-9f7a3"
});

const auth = firebase.auth();
const db = firebase.firestore();

// â˜ï¸ Cloudinary
const CLOUD_NAME = "dahxnopuw";
const UPLOAD_PRESET = "inventory_unsigned";

// ðŸ” Auth handling
auth.onAuthStateChanged(user=>{
  loginBox.classList.toggle("hidden", !!user);
  appBox.classList.toggle("hidden", !user);
  if(user) loadProducts();
});

function login(){
  auth.signInWithEmailAndPassword(email.value, password.value)
    .catch(e=>alert(e.message));
}

function logout(){
  auth.signOut();
}

// ðŸ“· Image compression
function compressImage(file){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement("canvas");
      const max=800;
      let w=img.width, h=img.height;

      if(w>h && w>max){ h*=max/w; w=max; }
      else if(h>max){ w*=max/h; h=max; }

      canvas.width=w;
      canvas.height=h;
      canvas.getContext("2d").drawImage(img,0,0,w,h);
      canvas.toBlob(b=>resolve(b),"image/jpeg",0.7);
    };
    img.src=URL.createObjectURL(file);
  });
}

// â˜ï¸ Cloudinary upload
async function uploadToCloudinary(file){
  const blob=await compressImage(file);
  const fd=new FormData();
  fd.append("file",blob);
  fd.append("upload_preset",UPLOAD_PRESET);

  const res=await fetch(
    `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,
    { method:"POST", body:fd }
  );

  const data=await res.json();
  return data.secure_url;
}

// âž• Add product
async function addProduct(){
  if(!pimage.files[0]) return alert("Image required");

  const imageUrl = await uploadToCloudinary(pimage.files[0]);

  await db.collection("products").add({
    name:pname.value,
    code:pcode.value,
    color:pcolor.value,
    size:psize.value,
    price:+pprice.value,
    stock:+pstock.value,
    image:imageUrl,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  hideAdd();
  loadProducts();
}

// ðŸ“¦ Load products
async function loadProducts(){
  products.innerHTML="";
  const q=search.value.toLowerCase();

  const snap=await db.collection("products").get();

  snap.forEach(d=>{
    const p=d.data();
    const text=(p.name+p.code+p.color+p.size).toLowerCase();
    if(q && !text.includes(q)) return;

    const div=document.createElement("div");
    div.className="card product";
    div.innerHTML=`
      <img src="${p.image}">
      <div>
        <b>${p.name}</b> (${p.color}, ${p.size})<br>
        ${p.code}<br>
        â‚¹${p.price}<br>
        <span class="${p.stock<5?'low':''}">Stock: ${p.stock}</span>
        <div class="actions">
          <button onclick="updateStock('${d.id}',1)">IN</button>
          <button onclick="updateStock('${d.id}',-1)">OUT</button>
        </div>
        <div id="qr${d.id}"></div>
      </div>
    `;
    products.appendChild(div);
    new QRCode("qr"+d.id, p.code);
  });
}

async function updateStock(id,delta){
  const ref=db.collection("products").doc(id);
  const doc=await ref.get();
  await ref.update({ stock: doc.data().stock + delta });
  loadProducts();
}

// ðŸ§© Modal control (FINAL)
function showAdd(){
  addBox.classList.remove("hidden");
  document.body.style.overflow="hidden";
}

function hideAdd(){
  addBox.classList.add("hidden");
  document.body.style.overflow="auto";
}
</script>

</body>
</html>
