<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Inventory App</title>

<style>
body{font-family:Arial;margin:20px}
input,select,button{padding:6px;margin:4px}
.hidden{display:none}
.card{border:1px solid #ccc;padding:10px;margin:10px 0}
.low{color:red;font-weight:bold}
</style>
</head>
<body>

<!-- ðŸ” LOCK SCREEN -->
<div id="lockScreen" style="position:fixed;inset:0;background:#f4f6f8;display:flex;align-items:center;justify-content:center">
  <div style="background:#fff;padding:20px">
    <h3>Staff Login</h3>
    <input id="staffName" placeholder="Staff name"><br>
    <input id="staffPwd" type="password" placeholder="Password"><br><br>
    <button onclick="login()">Login</button>
    <p id="lockErr" style="color:red"></p>
  </div>
</div>

<h2>Inventory Search</h2>

<input id="search" placeholder="Search / Scan product">
<button onclick="runSearch()">Search</button>

<div id="results"></div>

<div id="stockPanel" class="hidden">
  <h3>Stock IN / OUT</h3>

  <select id="binSelect"></select><br>
  <input id="qty" type="number" placeholder="Quantity">
  <select id="dir">
    <option value="1">IN</option>
    <option value="-1">OUT</option>
  </select><br>
  <input id="remark" placeholder="Remark (required for OUT)">
  <br><br>
  <button onclick="updateStock()">Update Stock</button>
  <p id="msg"></p>
</div>

<!-- ðŸ”¥ FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, where, updateDoc, addDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ðŸ”§ CHANGE THIS */
const firebaseConfig = {
  apiKey: "AIzaSyAMOEoWseBnscSrmpnZ2u9U7tgtuwWHeh4",
  authDomain: "inventory-app-9f7a3.firebaseapp.com",
  projectId: "inventory-app-9f7a3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.db=db;
window.fs={collection,getDocs,query,where,updateDoc,addDoc,doc};
</script>

<script>
/* ðŸ” CONFIG */
const STAFF_PASSWORD="staff123";   // change this
const LOW_STOCK=5;

let data=[], selectedRow=null;

/* AUTH */
function login(){
  if(staffPwd.value===STAFF_PASSWORD){
    localStorage.setItem("auth","yes");
    localStorage.setItem("staff",staffName.value||"Staff");
    lockScreen.style.display="none";
    loadInventory();
  }else lockErr.innerText="Wrong password";
}
if(localStorage.getItem("auth")==="yes"){
  lockScreen.style.display="none";
  loadInventory();
}

/* LOAD DATA */
async function loadInventory(){
  data=[];
  const snap=await fs.getDocs(fs.collection(db,"inventory"));
  snap.forEach(d=>data.push({id:d.id,...d.data()}));
}

/* SEARCH */
function runSearch(){
  results.innerHTML="";
  stockPanel.classList.add("hidden");

  const q=search.value.toLowerCase();
  if(!q) return;

  const found=data.filter(d=>
    d.code.toLowerCase().includes(q) ||
    d.name.toLowerCase().includes(q) ||
    d.color.toLowerCase().includes(q) ||
    d.size.toLowerCase().includes(q)
  );

  if(!found.length){
    results.innerHTML="<p>No product found</p>";
    return;
  }

  found.forEach(d=>{
    const div=document.createElement("div");
    div.className="card";
    if(d.stock<=LOW_STOCK) div.classList.add("low");

    div.innerHTML=`
      <b>${d.code}</b> - ${d.name}<br>
      Color: ${d.color} | Size: ${d.size} | Bin: ${d.bin}<br>
      Stock: ${d.stock} | Price: â‚¹${d.price}<br>
      <button>Select</button>
    `;
    div.querySelector("button").onclick=()=>selectRow(d);
    results.appendChild(div);
  });
}

/* SELECT */
function selectRow(d){
  selectedRow=d;
  stockPanel.classList.remove("hidden");
  binSelect.innerHTML=`<option>${d.bin}</option>`;
}

/* STOCK UPDATE */
async function updateStock(){
  if(!selectedRow) return;

  const qtyVal=Number(qty.value)*Number(dir.value);
  if(!qtyVal) return alert("Enter quantity");

  if(qtyVal<0 && !remark.value)
    return alert("Remark required for OUT");

  const newStock=selectedRow.stock+qtyVal;
  if(newStock<0) return alert("Insufficient stock");

  await fs.updateDoc(
    fs.doc(db,"inventory",selectedRow.id),
    {stock:newStock}
  );

  await fs.addDoc(fs.collection(db,"audit_logs"),{
    timestamp:new Date(),
    staff:localStorage.getItem("staff"),
    code:selectedRow.code,
    name:selectedRow.name,
    color:selectedRow.color,
    size:selectedRow.size,
    bin:selectedRow.bin,
    action:qtyVal>0?"IN":"OUT",
    qty:Math.abs(qtyVal),
    stockAfter:newStock,
    remark:remark.value||""
  });

  msg.innerText="Stock updated";
  qty.value="";
  remark.value="";
  loadInventory();
}
</script>

</body>
</html>
