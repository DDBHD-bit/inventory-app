<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Inventory App</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f1f5f9}
header{background:linear-gradient(135deg,#1e3a8a,#2563eb);color:#fff;padding:12px 16px;display:flex;justify-content:space-between}
.container{padding:16px;max-width:900px;margin:auto}
.card{background:#fff;border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
input,select,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
button.secondary{background:#64748b}
.hidden{display:none}
.product{display:flex;gap:12px;margin-top:10px}
.product img{width:80px;height:80px;border-radius:10px;object-fit:cover}
.low{color:#dc2626;font-weight:bold}
.size-row{margin-left:92px;margin-top:6px}
.size-row button{width:auto;margin-left:6px}
.color-badge{
  padding:2px 10px;
  border-radius:6px;
  color:#fff;
  font-size:13px;
}
</style>
</head>

<body>

<header>
  <b>Inventory</b>
  <button onclick="openAudit()">Audit</button>
  <button onclick="openSummary()">Daily Summary</button>  
  <button onclick="logout()">Logout</button>
</header>

<!-- LOGIN -->
<div class="container" id="loginBox">
  <div class="card">
    <h3>Login</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>
</div>

<!-- APP -->
<div class="container hidden" id="appBox">
  <input id="search" placeholder="Search..." oninput="loadProducts()">
  <button onclick="showAdd()">➕ Add Product</button>
  <div id="products"></div>
</div>

<!-- ADD PRODUCT -->
<div class="container hidden" id="addBox">
  <div class="card">
    <h3>Add Product</h3>
    <input id="pcode" placeholder="Code">
    <input id="pname" placeholder="Name">


    <label>Color</label>
    <select id="pcolor">
      <option value="">Select Color</option>
      <option value="Red">Red</option>
      <option value="Blue">Blue</option>
      <option value="Green">Green</option>
      <option value="Black">Black</option>
      <option value="White">White</option>
      <option value="Yellow">Yellow</option>
      <option value="Brown">Brown</option>
      <option value="Grey">Grey</option>
    </select>

    <label>Size</label>
    <select id="psize">
      <option value="">Select Size</option>
      <option value="7 Feet">7 Feet</option>
      <option value="9 Feet">9 Feet</option>
    </select>

    <input id="pprice" type="number" placeholder="Price">
    <input id="pstock" type="number" placeholder="Stock">
    <input type="file" id="pimage" accept="image/*">

    <button onclick="addProduct()">Save</button>
    <button class="secondary" onclick="hideAdd()">Cancel</button>
  </div>
</div>
<!-- AUDIT LOG MODAL -->
<div class="container hidden" id="auditBox">
  <div class="card">
    <h3>Audit Logs</h3>
    <div id="auditList"></div>
    <button class="secondary" onclick="closeAudit()">Close</button>
  </div>
</div>

<!-- DAILY SUMMARY MODAL -->
<div class="container hidden" id="summaryBox">
  <div class="card">
    <h3>Today's Stock Movement</h3>
    <div id="summaryList"></div>
    <button class="secondary" onclick="closeSummary()">Close</button>
  </div>
</div>


  
<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyAMOEoWseBnscSrmpnZ2u9U7tgtuwWHeh4",
  authDomain: "inventory-app-9f7a3.firebaseapp.com",
  projectId: "inventory-app-9f7a3"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* ================= AUTH ================= */
function login(){
  auth.signInWithEmailAndPassword(email.value,password.value)
    .catch(e=>alert(e.message));
}
function logout(){ auth.signOut(); }

auth.onAuthStateChanged(u=>{
  loginBox.classList.toggle("hidden",!!u);
  appBox.classList.toggle("hidden",!u);
  if(u) loadProducts();
});

/* ================= UI ================= */
function showAdd(){ addBox.classList.remove("hidden"); }
function hideAdd(){ addBox.classList.add("hidden"); }

/* ================= IMAGE ================= */
function compressImage(file){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.createElement("canvas");
      const max=800;
      let w=img.width,h=img.height;
      if(w>h&&w>max){h*=max/w;w=max}
      else if(h>max){w*=max/h;h=max}
      c.width=w;c.height=h;
      c.getContext("2d").drawImage(img,0,0,w,h);
      c.toBlob(b=>resolve(b),"image/jpeg",0.7);
    };
    img.src=URL.createObjectURL(file);
  });
}

const CLOUD_NAME="dahxnopuw";
const UPLOAD_PRESET="inventory_unsigned";

async function uploadToCloudinary(file){
  const blob=await compressImage(file);
  const fd=new FormData();
  fd.append("file",blob);
  fd.append("upload_preset",UPLOAD_PRESET);
  const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,
    {method:"POST",body:fd});
  return (await r.json()).secure_url;
}

/* ================= ADD PRODUCT ================= */
async function addProduct(){
  if(!pimage.files[0]) return alert("Image required");
  if(!pcolor.value) return alert("Select color");

  const image=await uploadToCloudinary(pimage.files[0]);

  await db.collection("inventory").add({
    name:pname.value,
    code:pcode.value,
    color:pcolor.value,
    size:psize.value,
    price:Number(pprice.value),
    stock:Number(pstock.value),
    image,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
await db.collection("audit_logs").add({
  productId: "NEW",
  code: pcode.value,
  color: pcolor.value,
  size: psize.value,
  change: Number(pstock.value),
  type: "ADD",
  user: auth.currentUser.email,
  timestamp: firebase.firestore.FieldValue.serverTimestamp()
});
  hideAdd();
  loadProducts();
}

/* ================= LOAD PRODUCTS ================= */
async function loadProducts(){
  products.innerHTML="";
  const q=search.value.toLowerCase();
  const snap=await db.collection("inventory").get();
  const grouped={};

  snap.forEach(doc=>{
    const p=doc.data();
    const text=`${p.name} ${p.code} ${p.color} ${p.size}`.toLowerCase();
    if(q && !text.includes(q)) return;

    grouped[p.code] ??= {};
    grouped[p.code][p.color] ??= {image:p.image,name:p.name,sizes:[]};
    grouped[p.code][p.color].sizes.push({id:doc.id,...p});
  });

  if(Object.keys(grouped).length===0){
    products.innerHTML='<div class="card">No products found</div>';
    return;
  }

  Object.keys(grouped).forEach(code=>{
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<b>Product Code:</b> ${code}`;

    Object.keys(grouped[code]).forEach(color=>{
      const c=grouped[code][color];

      card.innerHTML+=`
        <div class="product">
          <img src="${c.image}">
          <div>
            <b>${c.name}</b><br>
            Color:
            <span class="color-badge" style="background:${color.toLowerCase()}">
              ${color}
            </span>
          </div>
        </div>
      `;

      c.sizes.forEach(s=>{
        card.innerHTML+=`
          <div class="size-row">
            Size <b>${s.size}</b> |
            ₹${s.price} |
            <span class="${s.stock<5?'low':''}">Stock ${s.stock}</span>
            <button type="button" onclick="stockPrompt('${s.id}','IN')">IN</button>
            <button type="button" onclick="stockPrompt('${s.id}','OUT')">OUT</button>
          </div>
        `;
      });
    });

    products.appendChild(card);
  });
}

/* ================= STOCK ================= */

async function updateStock(id,delta){
  const ref = db.collection("inventory").doc(id);
  const snap = await ref.get();

  if(!snap.exists){
    alert("Product not found");
    return;
  }

  const p = snap.data();
  const newStock = (p.stock || 0) + delta;

  if(newStock < 0){
    alert("Stock cannot be negative");
    return;
  }

  // update inventory
  await ref.update({ stock: newStock });

  // audit log
  await db.collection("audit_logs").add({
    productId: id,
    code: p.code,
    color: p.color,
    size: p.size,
    change: Math.abs(delta),
    type: delta > 0 ? "IN" : "OUT",
    user: auth.currentUser.email,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  loadProducts();
};




/* ================= STOCK PROMPT (GLOBAL) ================= */

window.stockPrompt = async function(id, type){
  console.log("Button clicked:", id, type); // DEBUG (keep for now)

  let qty = prompt(
    type === "IN"
      ? "Enter quantity to ADD"
      : "Enter quantity to DEDUCT"
  );

  if(qty === null) return;

  qty = Number(qty);

  if(isNaN(qty) || qty <= 0){
    alert("Enter a valid number");
    return;
  }

  if(type === "OUT") qty = -qty;

  await window.updateStock(id, qty);
};

/* ================= UPDATE STOCK (GLOBAL) ================= */

window.updateStock = async function(id, delta){
  console.log("Updating stock:", id, delta); // DEBUG

  const ref = db.collection("inventory").doc(id);
  const snap = await ref.get();

  if(!snap.exists){
    alert("Product not found");
    return;
  }

  const current = Number(snap.data().stock || 0);
  const updated = current + delta;

  if(updated < 0){
    alert("Stock cannot be negative");
    return;
  }

  await ref.update({ stock: updated });
  loadProducts();
};

  
</script>

</body>
</html>




