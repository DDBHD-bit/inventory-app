<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Inventory App</title>

<style>
body{font-family:Arial;background:#f4f6f8;padding:15px}
.search{width:100%;padding:10px;font-size:16px;margin-bottom:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:15px}
.card{background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.card img{width:100%;height:160px;object-fit:cover;border-radius:6px}
.badge{background:#eee;padding:3px 8px;border-radius:12px;font-size:12px;margin-right:4px}
.actions{display:flex;gap:6px;margin-top:8px}
button{padding:6px 10px;border:none;border-radius:5px;cursor:pointer}
.in{background:#e8f5e9}
.out{background:#ffebee}
.edit{background:#e3f2fd}
.del{background:#fce4ec}
.low{color:red;font-weight:bold}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:999}
.modal-box{background:#fff;padding:15px;width:90%;max-width:420px;border-radius:8px}
.modal-box input{width:100%;padding:8px;margin-bottom:8px}
.center{text-align:center;margin-top:15px}
</style>
</head>

<body>

<!-- üåê PUBLIC SEARCH -->
<div id="publicView">
  <h2>Product Search</h2>
  <input class="search" placeholder="Search product..."
         oninput="publicSearch(this.value)">
  <div id="publicResults" class="grid"></div>
  <div class="center">
    <button onclick="showLogin()">üîê Staff Login</button>
  </div>
</div>

<!-- üîê STAFF VIEW -->
<div id="staffView" style="display:none">
  <h2>Inventory</h2>

  <div id="adminBar" style="display:none;margin-bottom:10px">
    <button onclick="openAdd()">‚ûï Add Product</button>
  </div>

  <input class="search" placeholder="Search..."
         oninput="search(this.value)">
  <div id="list" class="grid"></div>

  <div class="center">
    <button onclick="logout()">Logout</button>
  </div>
</div>

<!-- LOGIN -->
<div id="loginModal" class="modal">
  <div class="modal-box">
    <h3>Staff Login</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <button onclick="closeLogin()">Cancel</button>
  </div>
</div>

<!-- ADD PRODUCT -->
<div id="addModal" class="modal">
  <div class="modal-box">
    <h3>Add Product</h3>
    <input id="a_code" placeholder="Code">
    <input id="a_name" placeholder="Name">
    <input id="a_color" placeholder="Color">
    <input id="a_size" placeholder="Size">
    <input id="a_bin" placeholder="Bin">
    <input id="a_price" type="number" placeholder="Price">
    <input id="a_stock" type="number" placeholder="Opening Stock">
    <input id="a_image" type="file" accept="image/*" capture="environment">
    <button onclick="saveProduct()">Save</button>
    <button onclick="closeAdd()">Cancel</button>
  </div>
</div>

<!-- EDIT -->
<div id="editModal" class="modal">
  <div class="modal-box">
    <h3>Edit Product</h3>
    <input id="e_name" placeholder="Name">
    <input id="e_color" placeholder="Color">
    <input id="e_size" placeholder="Size">
    <input id="e_bin" placeholder="Bin">
    <input id="e_price" type="number" placeholder="Price">
    <button onclick="saveEdit()">Save</button>
    <button onclick="closeEdit()">Cancel</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, doc,
  updateDoc, deleteDoc, increment, serverTimestamp, getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

/* üîë REPLACE WITH YOUR CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyAMOEoWseBnscSrmpnZ2u9U7tgtuwWHeh4",
  authDomain: "inventory-app-9f7a3.firebaseapp.com",
  projectId: "inventory-app-9f7a3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

let products=[], editId=null;

/* IMAGE COMPRESSION */
async function compressImage(file, maxWidth=1024, quality=0.7){
  return new Promise(resolve=>{
    const img=new Image(), reader=new FileReader();
    reader.onload=e=>img.src=e.target.result;
    img.onload=()=>{
      let w=img.width, h=img.height;
      if(w>maxWidth){ h=h*(maxWidth/w); w=maxWidth; }
      const c=document.createElement("canvas");
      c.width=w; c.height=h;
      c.getContext("2d").drawImage(img,0,0,w,h);
      c.toBlob(b=>resolve(b),"image/jpeg",quality);
    };
    reader.readAsDataURL(file);
  });
}

/* ROLE */
function isAdmin(){ return localStorage.getItem("role")==="admin"; }

/* LOAD */
async function load(){
  const snap=await getDocs(collection(db,"inventory"));
  products=snap.docs.map(d=>({id:d.id,...d.data()}));
  render(products);
}
load();

/* PUBLIC SEARCH */
window.publicSearch=q=>{
  q=q.toLowerCase(); publicResults.innerHTML="";
  products.filter(p=>p.name.toLowerCase().includes(q)||p.code.toLowerCase().includes(q))
    .forEach(p=>publicResults.innerHTML+=`
      <div class="card"><h3>${p.name}</h3>
      <span class="badge">${p.code}</span>
      <span class="badge">${p.color}</span></div>`);
};

/* STAFF SEARCH */
window.search=q=>{
  q=q.toLowerCase();
  render(products.filter(p=>p.name.toLowerCase().includes(q)||p.code.toLowerCase().includes(q)));
};

/* RENDER */
function render(data){
  list.innerHTML="";
  data.forEach(p=>{
    list.innerHTML+=`
    <div class="card">
      <img src="${p.image||'https://via.placeholder.com/300'}">
      <h3>${p.name}</h3>
      <div>
        <span class="badge">${p.code}</span>
        <span class="badge">${p.color}</span>
        <span class="badge">${p.size}</span>
      </div>
      <div>Bin: ${p.bin}</div>
      <div class="${p.stock<5?'low':''}">Stock: ${p.stock}</div>
      <b>‚Çπ${p.price}</b>
      <div class="actions">
        <button class="in" onclick="stock('${p.id}',1)">IN</button>
        <button class="out" onclick="stock('${p.id}',-1)">OUT</button>
      </div>
      ${isAdmin()?`
      <div class="actions">
        <button class="edit" onclick="edit('${p.id}')">Edit</button>
        <button class="del" onclick="remove('${p.id}','${p.code}')">Delete</button>
      </div>`:""}
    </div>`;
  });
}

/* STOCK */
window.stock=async(id,d)=>{
  const q=+prompt("Qty"); if(!q)return;
  await updateDoc(doc(db,"inventory",id),{stock:increment(d*q)});
  await addDoc(collection(db,"audit_logs"),{action:d>0?"IN":"OUT",qty:q,time:serverTimestamp()});
  load();
};

/* ADD */
window.openAdd=()=>addModal.style.display="flex";
window.closeAdd=()=>addModal.style.display="none";

window.saveProduct=async()=>{
  let imgURL="";
  if(a_image.files.length){
    const blob=await compressImage(a_image.files[0]);
    const refImg=ref(storage,"products/"+Date.now()+".jpg");
    await uploadBytes(refImg,blob);
    imgURL=await getDownloadURL(refImg);
  }
  await addDoc(collection(db,"inventory"),{
    code:a_code.value,name:a_name.value,color:a_color.value,
    size:a_size.value,bin:a_bin.value,price:+a_price.value,
    stock:+a_stock.value,image:imgURL,createdAt:serverTimestamp()
  });
  closeAdd(); load();
};

/* EDIT */
window.edit=id=>{
  editId=id;
  const p=products.find(x=>x.id===id);
  e_name.value=p.name; e_color.value=p.color;
  e_size.value=p.size; e_bin.value=p.bin;
  e_price.value=p.price;
  editModal.style.display="flex";
};
window.saveEdit=async()=>{
  await updateDoc(doc(db,"inventory",editId),{
    name:e_name.value,color:e_color.value,size:e_size.value,
    bin:e_bin.value,price:+e_price.value
  });
  closeEdit(); load();
};
window.closeEdit=()=>editModal.style.display="none";

/* DELETE */
window.remove=async(id)=>{
  if(confirm("Delete?")){
    await deleteDoc(doc(db,"inventory",id)); load();
  }
};

/* LOGIN */
window.showLogin=()=>loginModal.style.display="flex";
window.closeLogin=()=>loginModal.style.display="none";

window.login=async()=>{
  const c=await signInWithEmailAndPassword(auth,email.value,password.value);
  const snap=await getDoc(doc(db,"users",c.user.uid));
  localStorage.setItem("role",snap.data().role);
  publicView.style.display="none";
  staffView.style.display="block";
  if(isAdmin()) adminBar.style.display="block";
  loginModal.style.display="none";
};

window.logout=async()=>{
  await signOut(auth);
  localStorage.clear();
  staffView.style.display="none";
  publicView.style.display="block";
};

onAuthStateChanged(auth,u=>{
  if(u){ staffView.style.display="block"; publicView.style.display="none"; }
});
</script>
</body>
</html>

