<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Inventory App</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:12px}
button{padding:6px 10px;border:none;background:#007bff;color:white;border-radius:6px;cursor:pointer;margin:2px}
button.red{background:#dc3545}
.hidden{display:none}
.card{background:white;padding:12px;margin-top:12px;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.08)}
.variant{background:#f7f7f7;padding:6px;margin-top:6px;border-radius:6px}
.color{font-weight:bold}
.sizeRow{display:flex;justify-content:space-between;margin-top:4px}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10000}
.modalInner{background:white;padding:14px;border-radius:10px;width:320px;max-height:90%;overflow:auto}
input{width:100%;padding:6px;margin-bottom:6px}
img.prodImg{width:80px;border-radius:6px;margin-bottom:6px}
#loginBox{z-index:9999;position:relative;background:#fff;padding:20px;border-radius:8px;max-width:300px;margin:100px auto;box-shadow:0 4px 8px rgba(0,0,0,.2)}
#qrScanner{width:100%;max-width:320px;margin-top:10px}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginBox">
  <h3>Login</h3>
  <input id="email" type="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
</div>

<script>
/* ==================== FIREBASE ==================== */
firebase.initializeApp({
  
  apiKey: "AIzaSyAMOEoWseBnscSrmpnZ2u9U7tgtuwWHeh4",
  authDomain: "inventory-app-9f7a3.firebaseapp.com",
  projectId: "inventory-app-9f7a3"
});
const auth = firebase.auth();
const db = firebase.firestore();

// Cloudinary config
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dahxnopuw/image/upload";
const CLOUDINARY_PRESET = "inventory_unsigned";

let USER_ROLE="staff", ALL_DATA={}, html5QrCode;

/* ==================== LOGIN ==================== */
function login(){
  auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message));
}

/* ==================== POST-LOGIN ==================== */
auth.onAuthStateChanged(async user=>{
  if(!user) return;

  loginBox.style.display="none";

  // Create main app container
  const appUI = document.createElement("div");
  appUI.id = "appUI";
  document.body.appendChild(appUI);

  // Get user role
  const doc = await db.collection("users").doc(user.uid).get();
  USER_ROLE = doc.exists?doc.data().role:"staff";

  // ===== HEADER BUTTONS =====
  const header=document.createElement("div");
  header.innerHTML=`<h3>Inventory App</h3>`;
  appUI.appendChild(header);

  const scanBtn=document.createElement("button"); scanBtn.textContent="Scan QR"; appUI.appendChild(scanBtn);
  const searchInput=document.createElement("input"); searchInput.placeholder="Search code or name"; appUI.appendChild(searchInput);
  const listDiv=document.createElement("div"); listDiv.id="list"; appUI.appendChild(listDiv);
  const qrDiv=document.createElement("div"); qrDiv.id="qrScanner"; qrDiv.className="hidden"; appUI.appendChild(qrDiv);

  let addBox, summaryBox, auditBox, addBtn, dailyBtn, auditBtn;

  if(USER_ROLE==="admin"){
    // Add Product Button + Modal
    addBtn=document.createElement("button"); addBtn.textContent="Add Product"; appUI.appendChild(addBtn);
    addBox=document.createElement("div"); addBox.className="modal hidden";
    addBox.innerHTML=`<div class="modalInner">
      <h3>Add Product</h3>
      <input placeholder="Code" id="pCode">
      <input placeholder="Name" id="pName">
      <input placeholder="Color" id="pColor">
      <input placeholder="Size" id="pSize">
      <input type="number" placeholder="Stock" id="pStock">
      <input type="file" id="pImage" accept="image/*" capture="environment">
      <button id="saveProduct">Save</button>
      <button onclick="addBox.classList.add('hidden')">Cancel</button>
    </div>`; appUI.appendChild(addBox);

    // Daily Summary Button + Modal
    dailyBtn=document.createElement("button"); dailyBtn.textContent="Daily Summary"; appUI.appendChild(dailyBtn);
    summaryBox=document.createElement("div"); summaryBox.className="modal hidden";
    summaryBox.innerHTML=`<div class="modalInner">
      <h3>Daily Stock Movement</h3>
      <input type="date" id="summaryDate">
      <table><thead><tr><th>Code</th><th>Color</th><th>Size</th><th>IN</th><th>OUT</th><th>NET</th></tr></thead>
      <tbody id="summaryBody"></tbody></table>
      <button onclick="summaryBox.classList.add('hidden')">Close</button>
    </div>`; appUI.appendChild(summaryBox);

    // Audit Logs Button + Modal
    auditBtn=document.createElement("button"); auditBtn.textContent="Audit Logs"; appUI.appendChild(auditBtn);
    auditBox=document.createElement("div"); auditBox.className="modal hidden";
    auditBox.innerHTML=`<div class="modalInner">
      <h3>Audit Logs</h3>
      <table><thead><tr><th>Date</th><th>Code</th><th>Color</th><th>Size</th><th>Action</th><th>Qty</th><th>By</th></tr></thead>
      <tbody id="auditBody"></tbody></table>
      <button onclick="auditBox.classList.add('hidden')">Close</button>
    </div>`; appUI.appendChild(auditBox);
  }

  // Logout
  const logoutBtn=document.createElement("button"); logoutBtn.textContent="Logout"; logoutBtn.className="red"; logoutBtn.onclick=()=>auth.signOut(); appUI.appendChild(logoutBtn);

  /* ==================== EVENTS ==================== */
  if(USER_ROLE==="admin"){
    addBtn.onclick=()=>addBox.classList.remove("hidden");
    dailyBtn.onclick=()=>summaryBox.classList.remove("hidden");
    auditBtn.onclick=()=>auditBox.classList.remove("hidden");
    document.getElementById("saveProduct").onclick=addProduct;
  }
  searchInput.oninput=()=>filter(searchInput.value);
  scanBtn.onclick=startScan;

  loadInventory();
});

/* ==================== INVENTORY FUNCTIONS ==================== */
async function loadInventory(){
  const snap=await db.collection("inventory").get();
  ALL_DATA={};
  snap.forEach(d=>{
    const p=d.data();
    if(!ALL_DATA[p.code]) ALL_DATA[p.code]={code:p.code,name:p.name,variants:{},image:p.imageUrl||""};
    if(!ALL_DATA[p.code].variants[p.color]) ALL_DATA[p.code].variants[p.color]={};
    ALL_DATA[p.code].variants[p.color][p.size]=(ALL_DATA[p.code].variants[p.color][p.size]||0)+Number(p.stock);
  });
  render(ALL_DATA);
}

function render(data){
  const list=document.getElementById("list"); list.innerHTML="";
  Object.values(data).forEach(p=>{
    let vhtml="";
    Object.entries(p.variants).forEach(([color,sizes])=>{
      vhtml+=`<div class="variant"><div class="color">${color}</div>`;
      Object.entries(sizes).forEach(([size,qty])=>{
        vhtml+=`<div class="sizeRow"><span>Size ${size}: <b>${qty}</b></span>`;
        if(USER_ROLE==="admin") vhtml+=`<span><button onclick="stockChange('${p.code}','${color}','${size}',1)">+</button><button onclick="stockChange('${p.code}','${color}','${size}',-1)">-</button></span>`;
        vhtml+="</div>";
      });
      vhtml+="</div>";
    });
    list.innerHTML+=`<div class="card">${p.image?`<img src="${p.image}" class="prodImg">`:""}<b>${p.code}</b><br>${p.name}${vhtml}</div>`;
  });
}

function filter(q){q=q.toLowerCase(); const f={}; Object.values(ALL_DATA).forEach(p=>{if(p.code.toLowerCase().includes(q)||p.name.toLowerCase().includes(q)) f[p.code]=p}); render(f);}

/* ==================== STOCK IN/OUT ==================== */
async function stockChange(code,color,size,delta){
  const q=await db.collection("inventory").where("code","==",code).where("color","==",color).where("size","==",size).limit(1).get();
  if(q.empty) return;
  const doc=q.docs[0];
  const newStock=Math.max(0,(doc.data().stock||0)+delta);
  await doc.ref.update({stock:newStock});
  await db.collection("audit_logs").add({code,color,size,action:delta>0?"IN":"OUT",qty:Math.abs(delta),by:USER_ROLE,time:firebase.firestore.FieldValue.serverTimestamp()});
  loadInventory();
}

/* ==================== ADD PRODUCT ==================== */
async function uploadImage(file){if(!file) return ""; const fd=new FormData(); fd.append("file",file); fd.append("upload_preset",CLOUDINARY_PRESET); const r=await fetch(CLOUDINARY_URL,{method:"POST",body:fd}); return (await r.json()).secure_url;}
async function addProduct(){
  const img=document.getElementById("pImage").files[0];
  const imgUrl=await uploadImage(img);
  await db.collection("inventory").add({
    code:document.getElementById("pCode").value.trim(),
    name:document.getElementById("pName").value.trim(),
    color:document.getElementById("pColor").value.trim(),
    size:document.getElementById("pSize").value.trim(),
    stock:Number(document.getElementById("pStock").value),
    imageUrl:imgUrl,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  alert("Product added");
  document.getElementById("pCode").value=""; document.getElementById("pName").value="";
  document.getElementById("pColor").value=""; document.getElementById("pSize").value=""; document.getElementById("pStock").value="";
  loadInventory(); document.querySelector(".modal.hidden").classList.add("hidden");
}

/* ==================== QR SCAN ==================== */
function startScan(){
  const scanner=document.getElementById("qrScanner"); scanner.classList.remove("hidden");
  html5QrCode=new Html5Qrcode("qrScanner");
  html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250}, msg=>{
    navigator.vibrate?.(200); new Audio('https://www.soundjay.com/buttons/sounds/beep-07.mp3').play();
    filter(msg);
    html5QrCode.stop(); scanner.classList.add("hidden");
  }, err=>{});
}
</script>
</body>
</html>
