<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Inventory App</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:12px}
button{padding:6px 10px;border:none;background:#007bff;color:white;border-radius:6px;cursor:pointer;margin:2px}
button.red{background:#dc3545}
.hidden{display:none}
.card{background:white;padding:12px;margin-top:12px;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.08)}
.variant{background:#f7f7f7;padding:6px;margin-top:6px;border-radius:6px}
.color{font-weight:bold}
.sizeRow{display:flex;justify-content:space-between;margin-top:4px}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10000}
.modalInner{background:white;padding:14px;border-radius:10px;width:320px;max-height:90%;overflow:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#eee}
input{width:100%;padding:6px;margin-bottom:6px}
img.prodImg{width:80px;border-radius:6px;margin-bottom:6px}
#loginBox{z-index:9999;position:relative;background:#fff;padding:20px;border-radius:8px;max-width:300px;margin:100px auto;box-shadow:0 4px 8px rgba(0,0,0,.2)}
#qrScanner{width:100%;max-width:320px;margin-top:10px}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginBox">
  <h3>Login</h3>
  <input id="email" type="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
</div>

<script>
// ðŸ”¥ Firebase
firebase.initializeApp({

  apiKey: "AIzaSyAMOEoWseBnscSrmpnZ2u9U7tgtuwWHeh4",
  authDomain: "inventory-app-9f7a3.firebaseapp.com",
  projectId: "inventory-app-9f7a3"
});
const auth = firebase.auth();
const db = firebase.firestore();

// Cloudinary config
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dahxnopuw/image/upload";
const CLOUDINARY_PRESET = "inventory_unsigned";

let USER_ROLE="staff", ALL_DATA={}, html5QrCode;

// LOGIN
function login(){
  auth.signInWithEmailAndPassword(email.value,password.value).catch(e=>alert(e.message));
}

// AUTH STATE
auth.onAuthStateChanged(async user=>{
  if(!user) return;

  loginBox.style.display="none";

  // Create app container dynamically
  const appUI=document.createElement("div");
  appUI.id="appUI";
  document.body.appendChild(appUI);

  // Fetch role
  const doc = await db.collection("users").doc(user.uid).get();
  USER_ROLE = doc.exists?doc.data().role:"staff";

  // Build app UI dynamically
  buildAppUI();
  loadInventory();
});

// LOGOUT
function logout(){ auth.signOut(); }

// === BUILD APP UI DYNAMICALLY ===
function buildAppUI(){
  const appUI = document.getElementById("appUI");
  appUI.innerHTML=`
    <header>
      <h3>Inventory App</h3>
      <div>
        <button id="scanBtn">Scan QR</button>
        ${USER_ROLE==="admin"?'<button id="addBtn">Add Product</button><button id="dailyBtn">Daily Summary</button><button id="auditBtn">Audit Logs</button>':""}
        <button onclick="logout()" class="red">Logout</button>
      </div>
    </header>
    <input id="search" placeholder="Search code or name">
    <div id="list"></div>
    <div id="qrScanner" class="hidden"></div>

    <!-- Modals -->
    <div id="addBox" class="modal hidden">
      <div class="modalInner">
        <h3>Add Product</h3>
        <input id="pCode" placeholder="Code">
        <input id="pName" placeholder="Name">
        <input id="pColor" placeholder="Color">
        <input id="pSize" placeholder="Size">
        <input id="pStock" type="number" placeholder="Stock">
        <input type="file" id="pImage" accept="image/*" capture="environment">
        <button onclick="addProduct()">Save Product</button>
        <button class="red" onclick="hideAdd()">Cancel</button>
      </div>
    </div>

    <div id="auditBox" class="modal hidden">
      <div class="modalInner">
        <h3>Audit Logs</h3>
        <table><thead><tr><th>Date</th><th>Code</th><th>Color</th><th>Size</th><th>Action</th><th>Qty</th><th>By</th></tr></thead><tbody id="auditBody"></tbody></table>
        <button class="red" onclick="closeAudit()">Close</button>
      </div>
    </div>

    <div id="summaryBox" class="modal hidden">
      <div class="modalInner">
        <h3>Daily Stock Movement</h3>
        <input type="date" id="summaryDate">
        <table><thead><tr><th>Code</th><th>Color</th><th>Size</th><th>IN</th><th>OUT</th><th>NET</th></tr></thead><tbody id="summaryBody"></tbody></table>
        <button onclick="closeSummary()">Close</button>
      </div>
    </div>
  `;

  // Attach event listeners
  if(USER_ROLE==="admin"){
    document.getElementById("addBtn").onclick=()=>document.getElementById("addBox").classList.remove("hidden");
    document.getElementById("dailyBtn").onclick=()=>document.getElementById("summaryBox").classList.remove("hidden");
    document.getElementById("auditBtn").onclick=openAudit;
  }
  document.getElementById("search").oninput=filter;
  document.getElementById("scanBtn").onclick=startScan;
}

// === INVENTORY FUNCTIONS ===
async function loadInventory(){
  const snap = await db.collection("inventory").get();
  ALL_DATA={};
  snap.forEach(d=>{
    const p=d.data();
    if(!ALL_DATA[p.code]) ALL_DATA[p.code]={code:p.code,name:p.name,variants:{},image:p.imageUrl||""};
    if(!ALL_DATA[p.code].variants[p.color]) ALL_DATA[p.code].variants[p.color]={};
    ALL_DATA[p.code].variants[p.color][p.size] = (ALL_DATA[p.code].variants[p.color][p.size]||0)+Number(p.stock);
  });
  render(ALL_DATA);
}

function render(data){
  const list = document.getElementById("list");
  list.innerHTML="";
  Object.values(data).forEach(p=>{
    let vhtml="";
    Object.entries(p.variants).forEach(([color,sizes])=>{
      vhtml+=`<div class="variant"><div class="color">${color}</div>`;
      Object.entries(sizes).forEach(([size,qty])=>{
        vhtml+=`<div class="sizeRow"><span>Size ${size}: <b>${qty}</b></span>`;
        if(USER_ROLE==="admin"){
          vhtml+=`<span><button onclick="stockChange('${p.code}','${color}','${size}',1)">+</button><button onclick="stockChange('${p.code}','${color}','${size}',-1)">-</button></span>`;
        }
        vhtml+="</div>";
      });
      vhtml+="</div>";
    });
    list.innerHTML+=`<div class="card">${p.image?`<img src="${p.image}" class="prodImg">`:""}<b>${p.code}</b><br>${p.name}${vhtml}</div>`;
  });
}

function filter(){
  const q=document.getElementById("search").value.toLowerCase();
  const f={};
  Object.values(ALL_DATA).forEach(p=>{
    if(p.code.toLowerCase().includes(q)||p.name.toLowerCase().includes(q)) f[p.code]=p;
  });
  render(f);
}

// STOCK IN/OUT
async function stockChange(code,color,size,delta){
  const q=await db.collection("inventory").where("code","==",code).where("color","==",color).where("size","==",size).limit(1).get();
  if(q.empty) return;
  const doc=q.docs[0];
  const newStock=Math.max(0,(doc.data().stock||0)+delta);
  await doc.ref.update({stock:newStock});
  await db.collection("audit_logs").add({code,color,size,action:delta>0?"IN":"OUT",qty:Math.abs(delta),by:USER_ROLE,time:firebase.firestore.FieldValue.serverTimestamp()});
  loadInventory();
}

// ADD PRODUCT
async function uploadImage(file){if(!file) return ""; const fd=new FormData(); fd.append("file",file); fd.append("upload_preset",CLOUDINARY_PRESET); const r=await fetch(CLOUDINARY_URL,{method:"POST",body:fd}); return (await r.json()).secure_url;}
async function addProduct(){
  if(USER_ROLE!=="admin"){alert("Admin only"); return;}
  const imgUrl=await uploadImage(document.getElementById("pImage").files[0]);
  await db.collection("inventory").add({
    code:document.getElementById("pCode").value.trim(),
    name:document.getElementById("pName").value.trim(),
    color:document.getElementById("pColor").value.trim(),
    size:document.getElementById("pSize").value.trim(),
    stock:Number(document.getElementById("pStock").value),
    imageUrl:imgUrl,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  alert("Product added"); document.getElementById("addBox").classList.add("hidden"); loadInventory();
}

// AUDIT LOG
function openAudit(){document.getElementById("auditBox").classList.remove("hidden"); loadAudit();}
function closeAudit(){document.getElementById("auditBox").classList.add("hidden");}
async function loadAudit(){
  const tbody=document.getElementById("auditBody");
  const snap=await db.collection("audit_logs").orderBy("time","desc").limit(100).get();
  tbody.innerHTML="";
  snap.forEach(d=>{
    const a=d.data();
    const t=a.time?a.time.toDate().toLocaleString():"";
    tbody.innerHTML+=`<tr><td>${t}</td><td>${a.code}</td><td>${a.color}</td><td>${a.size}</td><td>${a.action}</td><td>${a.qty}</td><td>${a.by}</td></tr>`;
  });
  if(!tbody.innerHTML) tbody.innerHTML="<tr><td colspan='7'>No logs</td></tr>";
}

// DAILY SUMMARY
function openDailySummary(){const sb=document.getElementById("summaryBox"); sb.classList.remove("hidden"); document.getElementById("summaryDate").value=new Date().toISOString().split("T")[0]; loadSummary(document.getElementById("summaryDate").value);}
function closeSummary(){document.getElementById("summaryBox").classList.add("hidden");}
document.getElementById("appUI")?.addEventListener("change",e=>{if(e.target.id==="summaryDate") loadSummary(e.target.value);});
async function loadSummary(dateStr){
  const tbody=document.getElementById("summaryBody"); tbody.innerHTML="<tr><td colspan='6'>Loading...</td></tr>";
  const s=new Date(dateStr); s.setHours(0,0,0,0);
  const e=new Date(dateStr); e.setHours(23,59,59,999);
  const snap=await db.collection("audit_logs").where("time",">=",s).where("time","<=",e).get();
  const map={};
  snap.forEach(d=>{
    const a=d.data(); const k=`${a.code}_${a.color}_${a.size}`;
    if(!map[k]) map[k]={code:a.code,color:a.color,size:a.size,in:0,out:0};
    a.action==="IN"?map[k].in+=a.qty:map[k].out+=a.qty;
  });
  tbody.innerHTML="";
  Object.values(map).forEach(r=>{const net=r.in-r.out; tbody.innerHTML+=`<tr><td>${r.code}</td><td>${r.color}</td><td>${r.size}</td><td style="color:green">${r.in}</td><td style="color:red">${r.out}</td><td><b>${net>0?"+":""}${net}</b></td></tr>`});
  if(!tbody.innerHTML) tbody.innerHTML="<tr><td colspan='6'>No activity</td></tr>";
}

// QR SCAN
function startScan(){
  const scanner=document.getElementById("qrScanner");
  scanner.classList.remove("hidden");
  html5QrCode=new Html5Qrcode("qrScanner");
  html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250}, qrCodeMessage=>{
    navigator.vibrate?.(200); new Audio('https://www.soundjay.com/buttons/sounds/beep-07.mp3').play();
    filterQR(qrCodeMessage); stopScan();
  }, errorMessage=>{});
}
function stopScan(){if(html5QrCode) html5QrCode.stop(); document.getElementById("qrScanner").classList.add("hidden");}
function filterQR(msg){const q=msg.toLowerCase(); const f={}; Object.values(ALL_DATA).forEach(p=>{if(p.code.toLowerCase()===q) f[p.code]=p}); render(f);}
</script>
</body>
</html>
